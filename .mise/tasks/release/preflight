#!/usr/bin/env bash
#MISE description="Phase 1: Validate prerequisites for release"
set -euo pipefail

echo "═══════════════════════════════════════════════════════════"
echo "  Phase 1: PREFLIGHT"
echo "═══════════════════════════════════════════════════════════"

# Check 1: Working directory clean
echo "→ Checking working directory..."
if [[ -n "$(git status --porcelain)" ]]; then
    echo "  ✗ Working directory not clean"
    git status --short
    exit 1
fi
echo "  ✓ Working directory clean"

# Check 2: GitHub authentication (token file check - no API calls to avoid process storms)
echo "→ Checking GitHub authentication..."
if [[ -z "${GH_TOKEN:-}" ]]; then
    echo "  ✗ GH_TOKEN not set"
    echo "    Run: eval \"\$(mise env)\" or check .mise.toml"
    exit 1
fi
# Validate token is not empty/whitespace
if [[ -z "$(echo "$GH_TOKEN" | tr -d '[:space:]')" ]]; then
    echo "  ✗ GH_TOKEN is empty"
    exit 1
fi
# Check token format (should start with ghp_ or github_pat_)
if [[ ! "$GH_TOKEN" =~ ^(ghp_|github_pat_) ]]; then
    echo "  ⚠ GH_TOKEN format unusual (expected ghp_* or github_pat_*)"
fi
echo "  ✓ GH_TOKEN present (${#GH_TOKEN} chars)"

# Check 3: Expected account (from GH_ACCOUNT env, set by mise)
if [[ -n "${GH_ACCOUNT:-}" ]]; then
    echo "  ✓ Target account: $GH_ACCOUNT (from GH_ACCOUNT env)"
else
    echo "  ⚠ GH_ACCOUNT not set - releasing with token from mise.toml"
fi

# Check 4: Plugin validation
echo "→ Validating plugins..."
if ! bun scripts/validate-plugins.mjs 2>/dev/null; then
    echo "  ✗ Plugin validation failed"
    exit 1
fi
echo "  ✓ Plugins validated"

# Check 5: Releasable commits exist
echo "→ Checking for releasable commits..."
LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
if [[ -n "$LATEST_TAG" ]]; then
    COMMITS=$(git log "$LATEST_TAG"..HEAD --oneline 2>/dev/null | wc -l | tr -d ' ')
    if [[ "$COMMITS" -eq 0 ]]; then
        echo "  ✗ No commits since $LATEST_TAG"
        exit 1
    fi
    echo "  ✓ Found $COMMITS commits since $LATEST_TAG"
fi

echo ""
echo "✓ All preflight checks passed"
echo ""
