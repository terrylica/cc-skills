#!/usr/bin/env bash
#MISE description="Phase 3 of 4: Sync released version to local Claude Code environment. Updates marketplace repo, syncs hooks to settings.json, syncs commands to ~/.claude/commands/, auto-enables new plugins, and clears stale plugin cache."
set -euo pipefail

echo "═══════════════════════════════════════════════════════════"
echo "  Phase 3: SYNC (hooks + commands + cache)"
echo "═══════════════════════════════════════════════════════════"

MARKETPLACE_DIR="$HOME/.claude/plugins/marketplaces/cc-skills"
CACHE_DIR="$HOME/.claude/plugins/cache/cc-skills"

# Get current version
VERSION=$(jq -r '.version' package.json)
echo "Syncing version: v$VERSION"

# Step 1: Update marketplace repo
echo "→ Updating marketplace repo..."
if [[ -d "$MARKETPLACE_DIR/.git" ]]; then
    cd "$MARKETPLACE_DIR"
    git fetch origin --tags --quiet
    git reset --hard "v$VERSION" --quiet 2>/dev/null || git reset --hard origin/main --quiet
    git clean -fd --quiet
    echo "  ✓ Marketplace updated to v$VERSION"
    cd - > /dev/null
else
    echo "  ⚠ Marketplace not found at $MARKETPLACE_DIR"
fi

# Step 2: Sync hooks to settings.json
echo "→ Syncing hooks to settings.json..."
if [[ -x "./scripts/sync-hooks-to-settings.sh" ]]; then
    ./scripts/sync-hooks-to-settings.sh
else
    echo "  ⚠ Hook sync script not found"
fi

# Step 2b: Sync commands to ~/.claude/commands/
echo "→ Syncing commands to ~/.claude/commands/..."
if [[ -x "./scripts/sync-commands-to-settings.sh" ]]; then
    ./scripts/sync-commands-to-settings.sh
else
    echo "  ⚠ Command sync script not found"
fi

# Step 2c: Auto-enable new plugins in settings.json
echo "→ Enabling new plugins in settings.json..."
if [[ -x "./scripts/sync-enabled-plugins.sh" ]]; then
    ./scripts/sync-enabled-plugins.sh
else
    echo "  ⚠ Plugin sync script not found"
fi

# Step 3: Rebuild plugin cache from marketplace + update installed_plugins.json
echo "→ Rebuilding plugin cache..."
rm -rf "$CACHE_DIR"
CACHE_COUNT=0
for plugin_source in "$MARKETPLACE_DIR/plugins"/*/; do
    [[ -d "$plugin_source" ]] || continue
    plugin_name=$(basename "$plugin_source")
    plugin_target="$CACHE_DIR/$plugin_name/$VERSION"
    mkdir -p "$plugin_target"
    [[ -d "$plugin_source/skills" ]] && cp -r "$plugin_source/skills" "$plugin_target/"
    [[ -d "$plugin_source/hooks" ]] && cp -r "$plugin_source/hooks" "$plugin_target/"
    [[ -f "$plugin_source/plugin.json" ]] && cp "$plugin_source/plugin.json" "$plugin_target/"
    ((CACHE_COUNT++))
done
echo "  ✓ Cache rebuilt: $CACHE_COUNT plugin(s) at v$VERSION"

echo "→ Syncing installed_plugins.json..."
INSTALLED="$HOME/.claude/plugins/installed_plugins.json"
if [[ -f "$INSTALLED" ]]; then
    jq --arg v "$VERSION" --arg base "$CACHE_DIR" '
      del(.plugins["ralph@cc-skills"]) |
      del(.plugins["gmail-tools@cc-skills"]) |
      .plugins |= with_entries(
        if (.key | test("@cc-skills$")) then
          .value[0].version = $v |
          .value[0].installPath = ($base + "/" + (.key | split("@")[0]) + "/" + $v) |
          .value[0].lastUpdated = (now | todate)
        else . end
      )
    ' "$INSTALLED" > /tmp/cc_skills_installed.json \
    && mv /tmp/cc_skills_installed.json "$INSTALLED"
    echo "  ✓ installed_plugins.json synced to v$VERSION"
else
    echo "  ⚠ installed_plugins.json not found at $INSTALLED"
fi

echo ""
echo "✓ Sync phase complete"
echo ""
