#!/usr/bin/env bash
#MISE description="Phase 3: Sync hooks and update plugin cache"
set -euo pipefail

echo "═══════════════════════════════════════════════════════════"
echo "  Phase 3: SYNC (hooks + cache)"
echo "═══════════════════════════════════════════════════════════"

MARKETPLACE_DIR="$HOME/.claude/plugins/marketplaces/cc-skills"
CACHE_DIR="$HOME/.claude/plugins/cache/cc-skills"

# Get current version
VERSION=$(jq -r '.version' package.json)
echo "Syncing version: v$VERSION"

# Step 1: Update marketplace repo
echo "→ Updating marketplace repo..."
if [[ -d "$MARKETPLACE_DIR/.git" ]]; then
    cd "$MARKETPLACE_DIR"
    git fetch origin --tags --quiet
    git reset --hard "v$VERSION" --quiet 2>/dev/null || git reset --hard origin/main --quiet
    echo "  ✓ Marketplace updated to v$VERSION"
    cd - > /dev/null
else
    echo "  ⚠ Marketplace not found at $MARKETPLACE_DIR"
fi

# Step 2: Sync hooks to settings.json
echo "→ Syncing hooks to settings.json..."
if [[ -x "./scripts/sync-hooks-to-settings.sh" ]]; then
    ./scripts/sync-hooks-to-settings.sh
else
    echo "  ⚠ Hook sync script not found"
fi

# Step 2b: Auto-enable new plugins in settings.json
echo "→ Enabling new plugins in settings.json..."
if [[ -x "./scripts/sync-enabled-plugins.sh" ]]; then
    ./scripts/sync-enabled-plugins.sh
else
    echo "  ⚠ Plugin sync script not found"
fi

# Step 3: Clear stale plugin cache (users reinstall manually)
echo "→ Clearing stale plugin cache..."
if [[ -d "$CACHE_DIR" ]]; then
    rm -rf "$CACHE_DIR"
    echo "  ✓ Cache cleared - users should reinstall plugins with:"
    echo "    claude plugin install plugin-name@cc-skills"
else
    echo "  ✓ No cache to clear"
fi

echo ""
echo "✓ Sync phase complete"
echo ""
