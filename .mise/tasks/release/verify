#!/usr/bin/env bash
#MISE description="Phase 4 of 4: Post-release verification of all artifacts. Checks: git tag exists, GitHub release published (via curl API, not gh CLI), marketplace repo at correct version, hooks synced in settings.json, and hooks.json files valid in marketplace. Prints user-facing post-release steps."
set -euo pipefail

echo "═══════════════════════════════════════════════════════════"
echo "  Phase 4: VERIFY"
echo "═══════════════════════════════════════════════════════════"

VERSION=$(jq -r '.version' package.json)
CACHE_DIR="$HOME/.claude/plugins/cache/cc-skills"
SETTINGS="$HOME/.claude/settings.json"

# Check 1: Git tag exists
echo "→ Checking git tag..."
if git rev-parse "v$VERSION" &>/dev/null; then
    echo "  ✓ Tag v$VERSION exists"
else
    echo "  ✗ Tag v$VERSION not found"
fi

# Check 2: GitHub release exists (using curl to avoid gh CLI process storm risks)
echo "→ Checking GitHub release..."
RELEASE_URL="https://api.github.com/repos/terrylica/cc-skills/releases/tags/v$VERSION"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${GITHUB_TOKEN:-}" "$RELEASE_URL" 2>/dev/null || echo "000")
if [[ "$HTTP_STATUS" == "200" ]]; then
    echo "  ✓ GitHub release v$VERSION exists"
elif [[ "$HTTP_STATUS" == "404" ]]; then
    echo "  ✗ GitHub release v$VERSION not found"
else
    echo "  ⚠ Could not verify GitHub release (HTTP $HTTP_STATUS)"
fi

# Check 3: Marketplace updated
echo "→ Checking marketplace repo..."
MARKETPLACE_DIR="$HOME/.claude/plugins/marketplaces/cc-skills"
if [[ -d "$MARKETPLACE_DIR/.git" ]]; then
    MARKETPLACE_VERSION=$(jq -r '.version' "$MARKETPLACE_DIR/package.json" 2>/dev/null || echo "unknown")
    if [[ "$MARKETPLACE_VERSION" == "$VERSION" ]]; then
        echo "  ✓ Marketplace at v$VERSION"
    else
        echo "  ⚠ Marketplace at v$MARKETPLACE_VERSION (run: cd $MARKETPLACE_DIR && git pull)"
    fi
else
    echo "  ⚠ Marketplace not found - users should run: claude plugin marketplace add terrylica/cc-skills"
fi

# Check 4: Hooks in settings.json
echo "→ Checking hooks in settings.json..."
HOOK_COUNT=$(jq '[.hooks.PreToolUse[]?, .hooks.PostToolUse[]?, .hooks.Stop[]?] | length' "$SETTINGS" 2>/dev/null || echo 0)
CC_SKILLS_HOOKS=$(jq '[.hooks.PreToolUse[]?, .hooks.PostToolUse[]?, .hooks.Stop[]? | select(.hooks[]?.command | contains("cc-skills"))] | length' "$SETTINGS" 2>/dev/null || echo 0)
echo "  ✓ Total hooks: $HOOK_COUNT ($CC_SKILLS_HOOKS from cc-skills)"

# Check 5: Hook files in marketplace
echo "→ Verifying hook files in marketplace..."
HOOKS_OK=0
for PLUGIN_DIR in $(ls -d "$MARKETPLACE_DIR/plugins"/*/ 2>/dev/null); do
    HOOKS_JSON="$PLUGIN_DIR/hooks/hooks.json"
    if [[ -f "$HOOKS_JSON" ]] && jq empty "$HOOKS_JSON" 2>/dev/null; then
        ((HOOKS_OK++))
    fi
done
echo "  ✓ Valid hooks.json: $HOOKS_OK plugins"

# Check 6: No legacy commands/ directories in marketplace
echo "→ Checking for legacy commands/ directories..."
LEGACY_DIRS=$(find "$MARKETPLACE_DIR/plugins" -type d -name 'commands' 2>/dev/null | wc -l | tr -d ' ')
if [[ "$LEGACY_DIRS" -eq 0 ]]; then
    echo "  ✓ No legacy commands/ dirs (migration complete)"
else
    echo "  ✗ Found $LEGACY_DIRS legacy commands/ dir(s) — run: find \$MARKETPLACE_DIR/plugins -type d -name commands"
fi

# Check 7: Commands synced from skills
echo "→ Verifying commands synced to ~/.claude/commands/..."
COMMANDS_DIR="$HOME/.claude/commands"
CC_SKILLS_CMDS=$(grep -rl "cc-skills-marketplace" "$COMMANDS_DIR" 2>/dev/null | wc -l | tr -d ' ')
if [[ "$CC_SKILLS_CMDS" -gt 0 ]]; then
    echo "  ✓ Commands synced: $CC_SKILLS_CMDS skill(s) in ~/.claude/commands/"
else
    echo "  ⚠ No cc-skills commands found in $COMMANDS_DIR — run sync-commands-to-settings.sh"
fi

echo ""
echo "═══════════════════════════════════════════════════════════"
echo "  ✓ Release v$VERSION verified"
echo "═══════════════════════════════════════════════════════════"
echo ""
echo "Post-release steps for users:"
echo "  1. Update marketplace: cd ~/.claude/plugins/marketplaces/cc-skills && git pull"
echo "  2. Reinstall plugins: claude plugin install itp@cc-skills"
echo "  3. Sync hooks: ./scripts/sync-hooks-to-settings.sh"
echo "  4. Sync commands: ./scripts/sync-commands-to-settings.sh"
echo "  5. Restart Claude Code"
echo ""
